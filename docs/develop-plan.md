# H5充电站模拟器应用详细开发计划

## 项目信息
- **项目位置**: `c:\develop\learnspace\charge-simulator`
- **技术栈**: Next.js 15 + TypeScript + Tailwind CSS
- **预计工期**: 8-10个工作日

---

## 开发阶段规划

### 第一阶段：基础架构搭建（2天）

#### 任务1.1：完善TypeScript类型定义（0.5天）
**具体内容：**
- 创建 `types/charging.ts` 文件，定义所有充电相关的接口
- 创建 `types/api.ts` 文件，定义API响应格式
- 创建 `types/websocket.ts` 文件，定义WebSocket消息类型
- 根据API文档完善数据结构，确保与后端接口一致

**验收标准：**
- 所有类型定义完整且与后端API匹配
- TypeScript编译无错误
- 类型定义支持所有业务场景

#### 任务1.2：实现API客户端（0.5天）
**具体内容：**
- 创建 `lib/api/client.ts` 统一API客户端
- 实现请求拦截器、响应拦截器
- 添加错误处理和重试机制
- 配置环境变量支持（开发/测试/生产环境）

**验收标准：**
- API客户端支持GET、POST、PUT、DELETE方法
- 错误处理完善，用户友好的错误提示
- 支持请求超时和重试

#### 任务1.3：实现Station API集成（0.5天）
**具体内容：**
- 创建 `lib/api/stations.ts` 文件
- 实现所有Station服务接口调用：
  - `getStations()` - 获取充电站列表
  - `getStationDetail()` - 获取充电站详情
  - `getStationChargePoints()` - 获取充电桩列表
  - `startCharging()` - 启动充电
  - `stopCharging()` - 停止充电
- 添加接口参数验证和响应数据转换

**验收标准：**
- 所有API接口调用正常
- 参数验证完整
- 响应数据格式统一

#### 任务1.4：搭建WebSocket通信管理器（0.5天）
**具体内容：**
- 创建 `lib/websocket/OCPPWebSocketManager.ts`
- 实现WebSocket连接管理：
  - 连接建立和断开
  - 自动重连机制
  - 连接状态监控
- 实现OCPP1.6协议消息处理：
  - BootNotification
  - Heartbeat
  - StatusNotification
  - StartTransaction
  - StopTransaction
  - MeterValues

**验收标准：**
- WebSocket连接稳定
- OCPP消息格式符合规范
- 自动重连机制工作正常

---

### 第二阶段：页面开发（2.5天）

#### 任务2.1：完善首页充电站列表（0.5天）
**具体内容：**
- 修改现有的 `charging-stations.tsx` 组件
- 集成Station API获取真实数据
- 根据page1.html原型图优化UI：
  - 添加充电枪统计信息显示
  - 显示空闲枪数量、总枪数量
  - 显示交流枪、直流枪数量
  - 优化卡片布局和样式
- 添加加载状态和错误处理
- 实现下拉刷新功能

**验收标准：**
- 页面UI与原型图一致
- 数据加载正常，显示真实的充电站信息
- 充电枪统计信息准确
- 加载和错误状态处理完善

#### 任务2.2：开发充电站详情页（0.5天）
**具体内容：**
- 创建 `app/stations/[stationId]/page.tsx`
- 根据page2.html原型图实现UI：
  - 顶部导航栏（返回按钮 + 充电站名称）
  - 充电站基本信息展示
  - 充电桩列表展示
  - 每个充电桩显示状态、类型、功率等信息
- 集成API获取充电站详情和充电桩列表
- 实现充电桩状态实时更新

**验收标准：**
- 页面布局与原型图匹配
- 充电站信息显示完整
- 充电桩列表数据准确
- 状态更新及时

#### 任务2.3：开发充电枪选择和插枪页面（0.5天）
**具体内容：**
- 创建 `app/stations/[stationId]/chargers/[chargerId]/page.tsx`
- 创建 `app/stations/[stationId]/chargers/[chargerId]/connect/page.tsx`
- 根据page3.html原型图实现插枪提示页面：
  - "Connect Charger" 标题
  - 插枪提示文案
  - "Simulate Connect Charger" 按钮
- 实现充电枪选择逻辑：
  - 只允许选择空闲状态的充电枪
  - 显示充电枪详细信息
  - 状态验证和错误提示

**验收标准：**
- 只能选择空闲状态的充电枪
- 插枪页面UI与原型图一致
- 状态验证逻辑正确

#### 任务2.4：开发充电过程页面（1天）
**具体内容：**
- 创建 `app/stations/[stationId]/chargers/[chargerId]/charging/page.tsx`
- 根据page4.html和page5.html原型图实现：
  - 充电状态显示（准备中、充电中、完成）
  - 实时充电数据展示：
    - 当前功率
    - 电压、电流
    - 已充电量
    - 充电时长
  - 充电进度条或圆形进度指示器
  - "开始充电"和"结束充电"按钮
- 实现充电数据实时更新动画
- 添加充电完成提示

**验收标准：**
- 充电过程页面UI美观，数据展示清晰
- 实时数据更新流畅
- 充电状态切换正确
- 用户操作反馈及时

---

### 第三阶段：充电流程实现（2天）

#### 任务3.1：实现插枪操作和WebSocket通信（0.5天）
**具体内容：**
- 在插枪页面集成WebSocket通信
- 实现插枪操作流程：
  - 点击"模拟插枪"按钮
  - 发送StatusNotification消息到网关
  - 接收网关确认响应
  - 更新充电枪状态为"已连接"
- 添加插枪成功/失败的用户反馈
- 实现页面状态切换（插枪前→插枪后）

**验收标准：**
- WebSocket消息发送接收正常
- 插枪操作流程完整
- 状态更新及时准确
- 用户反馈清晰

#### 任务3.2：实现启动充电流程（0.5天）
**具体内容：**
- 实现启动充电完整流程：
  - 调用Station API的启动充电接口
  - 接收WebSocket的StartTransaction消息
  - 更新充电会话状态
  - 开始接收MeterValues数据
- 实现充电状态管理：
  - 准备中 → 充电中的状态切换
  - 充电会话数据存储
  - 错误状态处理

**验收标准：**
- 启动充电流程完整无误
- 状态切换逻辑正确
- 充电会话数据准确
- 错误处理完善

#### 任务3.3：实现充电数据实时更新（0.5天）
**具体内容：**
- 实现充电数据模拟和展示：
  - 接收WebSocket的MeterValues消息
  - 解析电表数据（功率、电压、电流、电量）
  - 实时更新页面显示
  - 添加数据变化动画效果
- 实现充电进度计算和显示
- 添加充电时长计时器

**验收标准：**
- 充电数据实时更新流畅
- 数据显示准确
- 进度计算正确
- 动画效果自然

#### 任务3.4：实现停止充电流程（0.5天）
**具体内容：**
- 实现停止充电完整流程：
  - 调用Station API的停止充电接口
  - 接收WebSocket的StopTransaction消息
  - 更新充电会话状态为完成
  - 显示充电结果摘要
- 实现充电结束后的状态重置：
  - 清理充电会话数据
  - 重置充电枪状态为空闲
  - 返回充电站详情页

**验收标准：**
- 停止充电流程完整
- 状态重置正确
- 充电结果显示准确
- 页面跳转正常

---

### 第四阶段：状态管理和优化（1.5天）

#### 任务4.1：实现心跳管理功能（0.5天）
**具体内容：**
- 创建 `hooks/useHeartbeatManager.ts`
- 实现APP启动时自动连接所有充电枪：
  - 获取所有充电站和充电桩数据
  - 批量建立WebSocket连接
  - 开始心跳发送
  - 更新充电枪在线状态
- 实现连接状态监控和管理
- 添加连接失败重试机制

**验收标准：**
- APP启动时所有充电枪自动上线
- 心跳机制稳定运行
- 连接状态监控准确
- 重试机制有效

#### 任务4.2：完善状态管理系统（0.5天）
**具体内容：**
- 创建 `lib/store/chargingStore.ts` 使用Zustand
- 实现全局状态管理：
  - 当前充电会话状态
  - 充电桩状态缓存
  - 实时充电数据
  - 连接状态管理
- 实现状态持久化（localStorage）
- 添加状态变化监听和通知

**验收标准：**
- 状态管理逻辑清晰
- 数据流向正确
- 状态持久化工作正常
- 组件间状态同步及时

#### 任务4.3：添加错误处理和重连机制（0.5天）
**具体内容：**
- 完善WebSocket错误处理：
  - 连接失败处理
  - 消息发送失败处理
  - 网络断开自动重连
  - 重连次数限制和退避策略
- 完善API错误处理：
  - 网络错误处理
  - 服务器错误处理
  - 超时处理
  - 用户友好的错误提示
- 添加全局错误边界组件

**验收标准：**
- 错误处理覆盖全面
- 重连机制稳定可靠
- 错误提示用户友好
- 应用稳定性高

---

### 第五阶段：开发者功能和优化（2天）

#### 任务5.1：开发设置页面（0.5天）
**具体内容：**
- 创建 `app/settings/page.tsx`
- 实现开发者选项界面：
  - 连接状态监控面板
  - 手动控制充电枪在线/离线开关
  - WebSocket连接信息显示
  - 调试日志查看器
  - 环境配置切换
- 添加设置页面入口（首页右上角设置按钮）

**验收标准：**
- 设置页面功能完整
- 开发者选项易用
- 调试信息详细
- 界面布局合理

#### 任务5.2：实现手动控制功能（0.5天）
**具体内容：**
- 在设置页面添加充电枪控制面板：
  - 显示所有充电枪列表
  - 每个充电枪的在线/离线状态切换开关
  - 批量操作功能（全部上线/全部离线）
  - 连接状态实时更新
- 实现手动控制逻辑：
  - 手动建立/断开WebSocket连接
  - 状态变化实时反馈
  - 操作日志记录

**验收标准：**
- 手动控制功能正常
- 状态切换及时
- 批量操作有效
- 操作反馈清晰

#### 任务5.3：性能优化和用户体验改进（0.5天）
**具体内容：**
- 页面性能优化：
  - 组件懒加载
  - 图片优化和懒加载
  - 列表虚拟滚动（如果数据量大）
  - 减少不必要的重渲染
- 用户体验优化：
  - 添加骨架屏加载效果
  - 优化页面切换动画
  - 添加操作成功/失败的Toast提示
  - 改进加载状态指示器

**验收标准：**
- 页面加载速度快
- 交互响应及时
- 动画效果流畅
- 用户反馈及时

#### 任务5.4：完善调试和日志功能（0.5天）
**具体内容：**
- 实现日志系统：
  - WebSocket消息日志
  - API请求日志
  - 用户操作日志
  - 错误日志
- 添加调试工具：
  - 消息发送测试工具
  - 状态查看器
  - 性能监控面板
- 实现日志导出功能

**验收标准：**
- 日志记录完整
- 调试工具好用
- 日志导出正常
- 便于问题排查

---

## 开发环境配置

### 环境变量配置
````bash path=.env.local mode=EDIT
# Station API配置
NEXT_PUBLIC_API_BASE_URL=http://localhost:8080/api/v1

# WebSocket网关配置
NEXT_PUBLIC_WEBSOCKET_URL=ws://localhost:8080/ocpp

# 调试模式
NEXT_PUBLIC_DEBUG_MODE=true

# 心跳间隔（毫秒）
NEXT_PUBLIC_HEARTBEAT_INTERVAL=300000
````

### 依赖包安装
```powershell
# 状态管理
npm install zustand

# WebSocket客户端
npm install ws @types/ws

# 日期处理
npm install date-fns

# 图标库
npm install lucide-react

# Toast提示
npm install react-hot-toast

# 动画库
npm install framer-motion
```

---

## 测试计划

### 单元测试（每个阶段完成后）
- WebSocket管理器功能测试
- API客户端功能测试
- 状态管理逻辑测试
- 工具函数测试

### 集成测试（第三阶段后）
- 完整充电流程测试
- WebSocket通信测试
- API接口集成测试

### 端到端测试（第五阶段后）
- 用户操作流程测试
- 多设备兼容性测试
- 性能压力测试

---

## 风险控制

### 技术风险
1. **WebSocket连接稳定性** - 实现完善的重连机制
2. **OCPP协议兼容性** - 严格按照规范实现
3. **状态同步一致性** - 完善的状态管理和错误处理

### 进度风险
1. **API接口依赖** - 提前与后端团队确认接口可用性
2. **原型图理解偏差** - 及时与设计师确认细节
3. **技术难点** - 预留缓冲时间处理复杂问题

### 质量风险
1. **用户体验** - 每个阶段都进行用户体验测试
2. **性能问题** - 持续监控和优化性能指标
3. **兼容性问题** - 在多种设备和浏览器上测试

---

**文档版本**: v1.0.0  
**创建日期**: 2025-01-27  
**预计完成时间**: 2025-02-07
